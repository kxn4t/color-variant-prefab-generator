# Color Variant Prefab Generator

[English](README.md)

Prefabへのマテリアル割り当てを快適にし、カラーバリエーションの **Prefab Variant** を効率よく作成するUnityエディター拡張です。  
サムネイル付きマテリアルブラウザーとシーンプレビューにより、モデルへのマテリアルセットアップ自体も手軽に行えます。VRChat向けアバター衣装をはじめ、アクセサリーやワールドアセットなど、色違いのPrefabを用意するあらゆる場面で活用できます。

よくわからないまま色ごとにPrefabを複製してOriginal Prefabとして保存してしまっていませんか？  
Prefabを丸ごと複製する方法では、ベースに修正が入るたびに全カラバリへ同じ変更を手動で反映しなければなりません。さらに衣装を複数のアバターへ展開する場合は、アバターごとにカラバリPrefabを一から作り直す必要があり、作業量が膨れ上がります。

本ツールは、マテリアルの差分だけを保持する **Prefab Variant** を自動生成することで、これらの問題を解決します。

## 特徴

- **CV Creator** — シーンプレビューを見ながらカラバリを1色ずつ作成
- **Batch Generator** — 作成済みのカラバリを別のベースPrefabへまとめて展開
- **マテリアルブラウザー** — フォルダー内のマテリアルをサムネイル付きで一覧表示、ドラッグ＆ドロップで割り当て
- **リアルタイムプレビュー** — マテリアル変更がシーンビューに即反映（Undo/Redo対応）
- **スマートマッチング** — 階層構造が異なるPrefab間でもマテリアルスロットを自動対応
- **既存Prefabからインポート** — 手動で作ったカラバリのマテリアル構成を取り込み可能

ベースPrefabへの変更はすべてのVariantに自動で反映されるため、カラバリの保守が格段に楽になります。

## 動作要件

- Unity 2022.3.22f1以上
- オプション: NDMF（Non-Destructive Modular Framework）1.11.0以降 — 日本語UIの表示に使用（NDMFがない場合は英語UIで動作します）

## インストール方法

### VRChat Creator Companion経由（推奨）

1. [https://kxn4t.github.io/vpm-repos/](https://kxn4t.github.io/vpm-repos/) にアクセス
2. 「Add to VCC」ボタンをクリックし、「Kanameliser VPM Packages」リポジトリをVCCまたはALCOMに追加
3. Manage Projectのパッケージ一覧から「Color Variant Prefab Generator」をプロジェクトに追加

### 手動インストール

1. [GitHub Releases](https://github.com/kxn4t/color-variant-prefab-generator/releases) から最新リリースをダウンロード
2. パッケージをUnityプロジェクトにインポート

## 使い方

両ツールとも、メニューバーの **Tools > Color Variant Prefab Generator** から開けます。

### 想定ワークフロー（衣装を複数アバターへ展開する例）

```
1. まず1体のアバターでカラバリを作り込む（CV Creator）
   ベースPrefab（例：Shinano_HonmeiKnit）をもとに
   Black, Blue, Brown … と各色のPrefab Variantを作成
   シーンプレビューで確認しながら、マテリアルのセットアップを完成させる

2. 完成したカラバリを別アバターへ一括展開する（Batch Generator）
   新しいアバターのベースPrefab（例：Airi_HonmeiKnit）を指定し、
   手順1で作ったカラバリPrefabをソースとしてまとめて追加
   マテリアルの差分が自動検出され、全色分のPrefab Variantを一括生成
```

最初の1つでカラバリのマテリアル構成をしっかり作り込み、それを雛形として他のベースPrefabへ展開する流れを想定しています。もちろんCV Creator単体でカラバリを作成するだけでも便利に使えます。

### CV Creator

マテリアルブラウザーとシーンプレビューを使い、カラーバリアントを1色ずつ丁寧に作成できます。  
モデルにマテリアルを割り当てていく作業においても便利です。

1. ベースPrefabをシーンのHierarchyに配置する
2. **Tools > Color Variant Prefab Generator > Creator** を開く
3. Hierarchyのインスタンスを **ベースPrefab** フィールドにドラッグする
4. 左パネルにRendererごとのマテリアルスロットが一覧表示される
5. 右パネルで **ルートフォルダー** を設定し、マテリアルを閲覧する
6. ドラッグ＆ドロップまたはピッカーでマテリアルを差し替える — 変更はシーンビューに即座に反映される
7. **Variant名**（例：「Black」）を入力し、出力パスを設定して **Prefab Variantを生成** をクリック
8. 生成後、次のアクションを選択するダイアログが表示される：
   - **オーバーライドを保持** — 現在の設定を維持したまま一部だけ変えて別の色を作成
   - **オーバーライドをクリア** — オーバーライドとバリアント名をクリアして次の色の作成へ

> **ヒント：** ベースPrefabフィールドには**Hierarchyのインスタンス**をドラッグしてください（Projectウィンドウのアセットではありません）。シーンプレビューにはシーン上のインスタンスが必要です。

> **Variantの親を選択：** ベースPrefabが多段Variant（例：Base → Black）の場合、出力設定に **Variantの親** ドロップダウンが表示されます。生成するVariantの親となる祖先Prefabを選択できます。たとえば「Red」を「Black」の子ではなく「Base」の直接の子として生成したい場合に便利です。

> **Prefabからインポート：** ベースPrefabフィールドのオプションメニュー（▼）から、既存Prefabのマテリアル構成を読み込むこともできます。マテリアルの差分が自動検出され、オーバーライドスロットに反映されます。

> **フォルダー指定：** 出力先やルートフォルダーには、Projectウィンドウからフォルダーをドラッグ＆ドロップで指定することもできます。

#### 「オーバーライドをクリア」とリバートモード

マテリアルの変更をリセットするには、**オーバーライドをクリア** ボタンを使用します。ドロップダウン（▾）から3つのリバートモードを選択できます：

| モード | 動作 |
|---|---|
| **表示のみ** | Prefabオーバーライドを元に戻さずマテリアルを復元 |
| **選択的Revert** | ツールが設定したオーバーライドのみ元に戻す |
| **完全Revert** | 対象Rendererのすべてのオーバーライドを元に戻す |

> **注意：** ウィンドウを閉じてもプレビュー中のマテリアル変更は自動的にリセットされません。**Ctrl+Z**（Undo）で元に戻せます。

### Batch Generator

作成済みのカラバリPrefabをソースに、別のベースPrefab向けのVariantをまとめて生成できます。たとえばあるアバター用に作ったカラバリを、別のアバター向けに一括展開するといった使い方ができます。ソースにはPrefab Variantだけでなく通常のPrefabも指定可能です。

1. **Tools > Color Variant Prefab Generator > Batch Generator** を開く
2. **新しいベースPrefab** にVariantを生成したいベースPrefabを設定する
3. **カラーバリアント** リストにソースPrefab（既存のカラーバリアント）を追加する — 複数のPrefabをまとめてドラッグ＆ドロップ可能
4. バリアント名が自動で付けられる — Prefab Variantの場合は親Prefab名との差分から、通常Prefabの場合はファイル名から導出される。鉛筆ボタン（✎）で手動編集も可能
5. 各ソースとベースが自動比較され、マテリアルの差分が検出される
6. **マッチング結果** を確認する — マッチしなかったスロットは警告表示され、ドロップダウンで手動割り当てが可能
7. 出力パスと命名テンプレートを設定する
8. （オプション）**「マテリアル差分がないVariantも作成する」**を有効にすると、ソースPrefabとベースのマテリアルが同一でもVariantを生成できる — ベースPrefabを別フォルダーに分けて管理したい場合に便利
9. **Prefab Variantを一括生成** をクリック

> **ヒント：** 出力先に同名ファイルが既に存在する場合は、すべて上書きするかキャンセルするかの確認ダイアログが表示されます。出力先にはフォルダーをドラッグ＆ドロップで指定することもできます。

### 命名テンプレート

両ツールとも、以下のプレースホルダーを使った命名テンプレートに対応しています。

| プレースホルダー | 説明 |
|---|---|
| `{BaseName}` | ベースPrefabのファイル名（拡張子なし、末尾の`_Base`は自動除去） |
| `{VariantName}` | 指定したVariant名 |

デフォルトテンプレート：`{BaseName}_{VariantName}`

例：ベース `Airi_HonmeiKnit` + Variant `Black` → `Airi_HonmeiKnit_Black.prefab`

> **ヒント：** Batch Generatorで同名のVariantが複数存在する場合、自動的に `_1`, `_2`, `_3` … のサフィックスが付与されます。  
> 例：`Black`, `Black`, `Black` → `Airi_HonmeiKnit_Black_1.prefab`, `Airi_HonmeiKnit_Black_2.prefab`, `Airi_HonmeiKnit_Black_3.prefab`

## 仕組み

### レンダラーマッチングアルゴリズム

2つのPrefabを比較する際、以下の4段階の優先度でマテリアルスロットをマッチングします。

| 優先度 | 戦略 | 説明 |
|---|---|---|
| P1 | 完全パス一致 | 同一の階層パス・オブジェクト名・スロットインデックス |
| P2 | 同一深度 | 同一の階層深度・オブジェクト名・スロットインデックス |
| P3 | 名前一致 | 深度を問わず、同一のオブジェクト名とスロットインデックス |
| P4 | あいまい一致 | 大文字小文字を無視した名前一致とスロットインデックス |

同じ優先度で複数の候補がある場合は、ベースマテリアル名の一致 → 階層深度の近さ → パスの類似度（レーベンシュタイン距離）の順に判定されます。

### 保存される内容

生成されたPrefab Variantにはマテリアルのオーバーライド**のみ**が含まれます。トランスフォームやコンポーネントの変更など、その他のプロパティは保存されません。これにより：

- ベースPrefabの変更（ボーン調整やコンポーネント設定など）がすべてのVariantに自動で反映される
- Variant間でプロパティが意図せずずれる心配がない

## ライセンス

[MIT](LICENSE) — Copyright (c) 2026 @kxn4t
